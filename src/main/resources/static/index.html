<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>StreamVideo Platform</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #111;
            color: #eee;
            padding: 20px;
        }
        h1, h2 { color: #00d1b2; }
        select, button {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
        }
        .container {
            display: flex;
            gap: 20px;
        }
        .player { flex: 3; }
        .recommendations {
            flex: 1;
            background: #1c1c1c;
            padding: 10px;
            border-radius: 6px;
        }
        video {
            width: 100%;
            max-height: 480px;
            background: black;
        }
        .rec-item {
            padding: 8px;
            margin-bottom: 6px;
            background: #2a2a2a;
            cursor: pointer;
            border-radius: 4px;
        }
        .rec-item:hover {
            background: #00d1b2;
            color: black;
        }
    </style>
</head>
<body>

<h1>ðŸŽ¥ StreamVideo Platform</h1>

<label>Select a video:</label>
<select id="videoSelect">
    <option value="">-- Select a video --</option>
</select>

<button onclick="loadRecommendations()">ðŸ“Œ Recommend Videos</button>

<div class="container">
    <div class="player">
        <video id="videoPlayer" controls></video>
        <p id="status"></p>
    </div>

    <div class="recommendations">
        <h2>Recommended</h2>
        <div id="recommendationList"></div>
    </div>
</div>

<script>
    const API_BASE = "http://localhost:8080/api";
    const USER_ID = "u1";

    const videoSelect = document.getElementById("videoSelect");
    const videoPlayer = document.getElementById("videoPlayer");
    const status = document.getElementById("status");
    const recommendationList = document.getElementById("recommendationList");

    let currentVideoId = null;
    let playStartTimestamp = null;
    let eventSent = false;

    // Load all videos
    fetch(`${API_BASE}/videos/getAllVideos`)
        .then(res => res.json())
        .then(videos => {
            videos.forEach(v => {
                const opt = document.createElement("option");
                opt.value = v.videoId;
                opt.textContent = v.title;
                videoSelect.appendChild(opt);
            });
        });

    // Video selection
    videoSelect.addEventListener("change", () => {
        flushWatchEvent();

        currentVideoId = videoSelect.value;
        if (!currentVideoId) return;

        eventSent = false;
        playStartTimestamp = Date.now();

        videoPlayer.src =
            `${API_BASE}/videos/watchSpecificVideo/${currentVideoId}`;
        videoPlayer.play();

        status.innerText = "Playing " + currentVideoId;
    });

    // ðŸ”¥ SEND WATCH EVENT (CORRECT)
    function flushWatchEvent() {
        if (!currentVideoId || !playStartTimestamp || eventSent) return;

        const watchedSeconds =
            Math.floor((Date.now() - playStartTimestamp) / 1000);

        if (watchedSeconds <= 0) return;

        const payload = JSON.stringify({
            userId: USER_ID,
            videoId: currentVideoId,
            watchDurationSeconds: watchedSeconds
        });

        navigator.sendBeacon(
            `${API_BASE}/watchEvent`,
            new Blob([payload], { type: "application/json" })
        );

        eventSent = true;
        playStartTimestamp = null;
    }

    // Lifecycle hooks
    videoPlayer.addEventListener("pause", flushWatchEvent);
    videoPlayer.addEventListener("ended", flushWatchEvent);
    window.addEventListener("pagehide", flushWatchEvent);

    // Manual recommend trigger
    function loadRecommendations() {
        fetch(`${API_BASE}/recommend/${USER_ID}`)
            .then(res => res.json())
            .then(data => {
                recommendationList.innerHTML = "";

                if (data.length === 0) {
                    recommendationList.innerHTML = "<p>No recommendations</p>";
                    return;
                }

                data.forEach(item => {
                    const div = document.createElement("div");
                    div.className = "rec-item";
                    div.innerText =
                        `â–¶ ${item.videoId} (score ${item.score.toFixed(2)})`;
                    div.onclick = () => {
                        videoSelect.value = item.videoId;
                        videoSelect.dispatchEvent(new Event("change"));
                    };
                    recommendationList.appendChild(div);
                });
            });
    }
</script>

</body>
</html>
